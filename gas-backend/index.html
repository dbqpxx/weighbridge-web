<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>焚化廠地磅查詢系統</title>
  <base target="_top">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <?!= include('styles'); ?>
</head>

<body>
  <div class="app-container">
    <!-- 側邊導航 -->
    <nav class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <svg viewBox="0 0 24 24" width="32" height="32" fill="currentColor">
            <path
              d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4H6v-2h4V7h2v4h4v2h-4v4z" />
          </svg>
        </div>
        <h1 class="app-title">焚化廠地磅系統</h1>
      </div>

      <ul class="nav-menu">
        <li class="nav-item active" data-page="dashboard">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
          </svg>
          <span>總覽</span>
        </li>
        <li class="nav-item" data-page="upload">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z" />
          </svg>
          <span>資料上傳</span>
        </li>
        <li class="nav-item" data-page="query">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path
              d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
          </svg>
          <span>查詢分析</span>
        </li>
        <li class="nav-item" data-page="comparison">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z" />
          </svg>
          <span>跨廠比較</span>
        </li>
        <li class="nav-item" data-page="reports">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path
              d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
          </svg>
          <span>報表匯出</span>
        </li>
      </ul>

      <div class="sidebar-footer">
        <div class="version">v1.0.0</div>
      </div>
    </nav>

    <!-- 主內容區 -->
    <main class="main-content">
      <!-- 頂部導航 -->
      <header class="top-header">
        <button class="menu-toggle" id="menuToggle">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </button>
        <h2 class="page-title" id="pageTitle">總覽</h2>
        <div class="header-actions">
          <span class="current-time" id="currentTime"></span>
        </div>
      </header>

      <!-- 頁面容器 -->
      <div class="page-container">

        <!-- 總覽頁面 -->
        <div class="page active" id="page-dashboard">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon blue">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                  <path
                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4H6v-2h4V7h2v4h4v2h-4v4z" />
                </svg>
              </div>
              <div class="stat-info">
                <h3 class="stat-value" id="totalRecords">-</h3>
                <p class="stat-label">總車次</p>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon green">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                  <path
                    d="M12 3L2 12h3v8h14v-8h3L12 3zm0 12.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                </svg>
              </div>
              <div class="stat-info">
                <h3 class="stat-value" id="totalWeight">-</h3>
                <p class="stat-label">總淨重 (噸)</p>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon orange">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                  <path
                    d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z" />
                </svg>
              </div>
              <div class="stat-info">
                <h3 class="stat-value" id="totalAmount">-</h3>
                <p class="stat-label">處理費收入 (元)</p>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon purple">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                  <path
                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                </svg>
              </div>
              <div class="stat-info">
                <h3 class="stat-value" id="avgWeight">-</h3>
                <p class="stat-label">平均車重 (公斤)</p>
              </div>
            </div>
          </div>

          <!-- 圖表區 -->
          <div class="charts-grid">
            <div class="chart-card">
              <h3 class="chart-title">各廠處理量比較</h3>
              <div class="chart-container">
                <canvas id="plantComparisonChart"></canvas>
              </div>
            </div>

            <div class="chart-card">
              <h3 class="chart-title">垃圾種類分佈</h3>
              <div class="chart-container">
                <canvas id="wasteTypeChart"></canvas>
              </div>
            </div>

            <div class="chart-card full-width">
              <h3 class="chart-title">每日進廠趨勢</h3>
              <div class="chart-container">
                <canvas id="dailyTrendChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- 資料上傳頁面 -->
        <div class="page" id="page-upload">
          <div class="upload-section">
            <div class="upload-card">
              <h3>上傳月報表</h3>

              <div class="form-group">
                <label for="uploadPlant">選擇廠區</label>
                <select id="uploadPlant" class="form-control">
                  <option value="">請選擇廠區</option>
                  <option value="south">南區廠</option>
                  <option value="renwu">仁武廠</option>
                  <option value="gangshan">岡山廠</option>
                </select>
              </div>

              <div class="form-group">
                <label for="uploadYearMonth">年月</label>
                <input type="text" id="uploadYearMonth" class="form-control" placeholder="例如: 115-01">
              </div>

              <div class="form-group">
                <label>選擇檔案 (Excel 或 CSV)</label>
                <div class="file-upload-area" id="fileUploadArea">
                  <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor">
                    <path
                      d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" />
                  </svg>
                  <p>拖曳檔案至此或點擊選擇</p>
                  <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" hidden>
                </div>
                <p class="file-name" id="fileName"></p>
              </div>

              <div class="form-group">
                <button class="btn btn-primary" id="uploadBtn" disabled>
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z" />
                  </svg>
                  上傳資料
                </button>
              </div>

              <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">處理中...</p>
              </div>

              <div class="upload-result" id="uploadResult"></div>
            </div>

            <!-- 上傳記錄 -->
            <div class="upload-history-card">
              <h3>最近上傳記錄</h3>
              <table class="data-table" id="uploadHistoryTable">
                <thead>
                  <tr>
                    <th>時間</th>
                    <th>廠區</th>
                    <th>年月</th>
                    <th>筆數</th>
                  </tr>
                </thead>
                <tbody id="uploadHistoryBody">
                  <tr>
                    <td colspan="4" class="no-data">暫無記錄</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 查詢分析頁面 -->
        <div class="page" id="page-query">
          <div class="query-section">
            <!-- 篩選條件 -->
            <div class="filter-card">
              <h3>查詢條件</h3>

              <div class="filter-grid">
                <div class="form-group">
                  <label for="queryStartDate">開始日期</label>
                  <input type="date" id="queryStartDate" class="form-control">
                </div>

                <div class="form-group">
                  <label for="queryEndDate">結束日期</label>
                  <input type="date" id="queryEndDate" class="form-control">
                </div>

                <div class="form-group">
                  <label>廠區</label>
                  <div class="checkbox-group">
                    <label class="checkbox-label">
                      <input type="checkbox" name="queryPlant" value="south" checked> 南區廠
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="queryPlant" value="renwu" checked> 仁武廠
                    </label>
                    <label class="checkbox-label">
                      <input type="checkbox" name="queryPlant" value="gangshan" checked> 岡山廠
                    </label>
                  </div>
                </div>

                <div class="form-group">
                  <label for="queryWasteType">垃圾種類</label>
                  <input type="text" id="queryWasteType" list="wasteTypeList" class="form-control"
                    placeholder="請選擇或輸入垃圾種類">
                  <datalist id="wasteTypeList">
                    <option value="全部">
                    <option value="一般廢棄物">
                    <option value="事業廢棄物">
                    <option value="廚餘">
                    <option value="廚餘焚化">
                    <option value="底渣">
                    <option value="底渣生垃圾回運">
                    <option value="水肥(轉入)">
                    <option value="水肥轉運(轉出)">
                    <option value="固化物">
                    <option value="環保局巨大垃圾">
                    <option value="區隊廚餘運入">
                    <option value="公務單位一般事業廢棄物(免費)">
                  </datalist>
                </div>

                <div class="form-group">
                  <label for="queryDistrict">區隊</label>
                  <input type="text" id="queryDistrict" list="districtList" class="form-control" placeholder="請選擇或輸入區隊">
                  <datalist id="districtList">
                    <!-- 動態載入 -->
                  </datalist>
                </div>

                <div class="form-group">
                  <label for="queryVendor">廠商</label>
                  <input type="text" id="queryVendor" list="vendorList" class="form-control" placeholder="請選擇或輸入廠商">
                  <datalist id="vendorList">
                    <!-- 動態載入 -->
                  </datalist>
                </div>

                <div class="form-group btn-group">
                  <button class="btn btn-primary" id="queryBtn">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                      <path
                        d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
                    </svg>
                    查詢
                  </button>
                  <button class="btn btn-secondary" id="resetBtn">重設</button>
                </div>
              </div>
            </div>

            <!-- 查詢結果統計 -->
            <div class="query-stats" id="queryStats" style="display: none;">
              <div class="stat-mini">
                <span class="label">查詢筆數</span>
                <span class="value" id="queryCount">0</span>
              </div>
              <div class="stat-mini">
                <span class="label">總淨重</span>
                <span class="value" id="queryWeight">0 噸</span>
              </div>
              <div class="stat-mini">
                <span class="label">總金額</span>
                <span class="value" id="queryAmount">0 元</span>
              </div>
            </div>

            <!-- 查詢結果表格 -->
            <div class="result-card">
              <div class="result-header">
                <h3>查詢結果</h3>
                <div class="result-actions">
                  <!-- 明細/匯總切換 -->
                  <div class="view-toggle">
                    <button class="btn btn-sm active" id="viewDetailBtn">明細</button>
                    <button class="btn btn-sm" id="viewSummaryBtn">匯總</button>
                  </div>
                  <button class="btn btn-outline" id="exportExcelBtn" disabled>
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                      <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                    </svg>
                    匯出 Excel
                  </button>
                </div>
              </div>

              <!-- 明細表格 -->
              <div class="table-container" id="detailView">
                <table class="data-table" id="queryResultTable">
                  <thead>
                    <tr>
                      <th>序號</th>
                      <th>廠區</th>
                      <th>日期時間</th>
                      <th>車道</th>
                      <th>車號</th>
                      <th>區隊/廠商</th>
                      <th>垃圾種類</th>
                      <th class="text-right">總重</th>
                      <th class="text-right">空重</th>
                      <th class="text-right">淨重</th>
                      <th class="text-right">金額</th>
                      <th>備註</th>
                    </tr>
                  </thead>
                  <tbody id="queryResultBody">
                    <tr>
                      <td colspan="12" class="no-data">請設定查詢條件後點擊查詢</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- 匯總表格 -->
              <div class="table-container" id="summaryView" style="display: none;">
                <table class="data-table" id="summaryTable">
                  <thead>
                    <tr>
                      <th>垃圾種類</th>
                      <th>車次</th>
                      <th>淨重 (噸)</th>
                      <th>金額 (元)</th>
                      <th>佔比 (%)</th>
                    </tr>
                  </thead>
                  <tbody id="summaryBody">
                    <tr>
                      <td colspan="5" class="no-data">請設定查詢條件後點擊查詢</td>
                    </tr>
                  </tbody>
                  <tfoot id="summaryFooter" style="display: none;">
                    <tr style="font-weight: bold; background: #f1f5f9;">
                      <td>合計</td>
                      <td id="summaryTotalCount">0</td>
                      <td id="summaryTotalWeight">0</td>
                      <td id="summaryTotalAmount">0</td>
                      <td>100%</td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <div class="pagination" id="pagination" style="display: none;">
                <button class="btn btn-sm" id="prevPage">上一頁</button>
                <span class="page-info" id="pageInfo">第 1 頁</span>
                <button class="btn btn-sm" id="nextPage">下一頁</button>
              </div>
            </div>
          </div>
        </div>

        <!-- 跨廠比較頁面 -->
        <div class="page" id="page-comparison">
          <div class="comparison-section">
            <!-- 篩選條件 -->
            <div class="filter-card">
              <h3>比較條件</h3>
              <div class="filter-row">
                <div class="form-group">
                  <label for="compStartDate">開始日期</label>
                  <input type="date" id="compStartDate" class="form-control">
                </div>
                <div class="form-group">
                  <label for="compEndDate">結束日期</label>
                  <input type="date" id="compEndDate" class="form-control">
                </div>
                <div class="form-group">
                  <button class="btn btn-primary" id="compQueryBtn">載入比較資料</button>
                </div>
              </div>
            </div>

            <!-- 比較圖表 -->
            <div class="charts-grid">
              <div class="chart-card">
                <h3 class="chart-title">各廠月處理量比較</h3>
                <div class="chart-container">
                  <canvas id="compPlantChart"></canvas>
                </div>
              </div>

              <div class="chart-card">
                <h3 class="chart-title">各廠垃圾種類分佈</h3>
                <div class="chart-container">
                  <canvas id="compWasteChart"></canvas>
                </div>
              </div>

              <div class="chart-card full-width">
                <h3 class="chart-title">各廠每日處理量趨勢</h3>
                <div class="chart-container">
                  <canvas id="compTrendChart"></canvas>
                </div>
              </div>
            </div>

            <!-- 比較表格 -->
            <div class="comparison-table-card">
              <h3>跨廠統計比較表</h3>
              <table class="data-table" id="comparisonTable">
                <thead>
                  <tr>
                    <th>項目</th>
                    <th>南區廠</th>
                    <th>仁武廠</th>
                    <th>岡山廠</th>
                    <th>合計</th>
                  </tr>
                </thead>
                <tbody id="comparisonBody">
                  <tr>
                    <td colspan="5" class="no-data">請選擇日期範圍後載入資料</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- 報表匯出頁面 -->
        <div class="page" id="page-reports">
          <div class="reports-section">
            <div class="report-card">
              <h3>月報表產生</h3>
              <p class="report-desc">選擇廠區與月份，產生完整的月統計報表</p>

              <div class="form-group">
                <label for="reportPlant">廠區</label>
                <select id="reportPlant" class="form-control">
                  <option value="">全部廠區</option>
                  <option value="south">南區廠</option>
                  <option value="renwu">仁武廠</option>
                  <option value="gangshan">岡山廠</option>
                </select>
              </div>

              <div class="form-group">
                <label for="reportYearMonth">年月</label>
                <input type="text" id="reportYearMonth" class="form-control" placeholder="例如: 115-01">
              </div>

              <div class="report-actions">
                <button class="btn btn-primary" id="generatePdfBtn">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path
                      d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z" />
                  </svg>
                  產生 PDF 報表
                </button>
                <button class="btn btn-secondary" id="generateExcelBtn">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                  </svg>
                  匯出 Excel
                </button>
              </div>
            </div>

            <div class="report-card">
              <h3>自訂報表</h3>
              <p class="report-desc">根據自訂條件產生分析報表</p>

              <div class="form-group">
                <label>報表類型</label>
                <div class="radio-group">
                  <label class="radio-label">
                    <input type="radio" name="reportType" value="wasteType" checked> 垃圾種類分析
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="reportType" value="source"> 區隊/廠商分析
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="reportType" value="trend"> 趨勢分析
                  </label>
                </div>
              </div>

              <button class="btn btn-outline" id="customReportBtn">產生自訂報表</button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Toast 通知 -->
  <div class="toast-container" id="toastContainer"></div>

  <?!= include('scripts'); ?>
</body>

</html>